<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>AI Mobile: Saturn Edition</title>
    <!-- –ó–∞–ø—Ä–µ—Ç –∑—É–º–∞ –¥–ª—è –æ—â—É—â–µ–Ω–∏—è –Ω–∞—Ç–∏–≤–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <style>
        :root {
            --primary: #00ff88;
            --glass: rgba(10, 10, 10, 0.85);
            --border: rgba(255, 255, 255, 0.2);
            --success: #00ff00;
            --error: #ff3333;
        }
        body { 
            margin: 0; overflow: hidden; background: #000; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            color: white; user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* –≠–ö–†–ê–ù –ó–ê–ü–£–°–ö–ê */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at center, #222 0%, #000 100%);
            z-index: 999; display: flex; flex-direction: column; 
            align-items: center; justify-content: center; text-align: center;
        }
        #start-btn {
            padding: 20px 60px; font-size: 18px; background: var(--primary); color: #000;
            border: none; border-radius: 50px; font-weight: 800; margin-top: 20px;
            box-shadow: 0 0 30px rgba(0, 255, 136, 0.4); text-transform: uppercase;
        }

        /* –ì–õ–ê–í–ù–´–ô UI */
        #canvas-container { position: absolute; top:0; left:0; width:100%; height:100%; z-index: 1; }
        
        .ui-panel {
            position: absolute; top: 10px; right: 10px; width: 220px;
            background: var(--glass); backdrop-filter: blur(10px);
            padding: 15px; border-radius: 16px; border: 1px solid var(--border);
            z-index: 10; display: none; transition: opacity 0.5s;
        }
        
        /* –ö–ù–û–ü–ö–ò */
        button.toggle-btn {
            background: rgba(255,255,255,0.1); border: 2px solid transparent;
            color: #ccc; padding: 12px; border-radius: 8px; 
            font-size: 12px; font-weight: bold; width: 100%; margin-bottom: 8px;
        }
        button.toggle-btn.active { background: rgba(255,255,255,0.2); color: #fff; }
        
        #btn-full { border: 1px solid var(--primary); color: var(--primary); background: rgba(0,0,0,0.5); }

        /* –°—Ç–∞—Ç—É—Å—ã –∫–∞–º–µ—Ä—ã */
        #btn-cam.status-lost { border-color: var(--error); }
        #btn-cam.status-ok { border-color: var(--success); color: var(--success); }

        /* –°–µ—Ç–∫–∞ —Ñ–æ—Ä–º */
        .shape-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        button.shape-btn {
            background: rgba(255,255,255,0.1); border: 1px solid var(--border);
            color: #ccc; padding: 12px; border-radius: 8px; font-size: 12px;
        }
        button.shape-btn.active { background: var(--primary); color: #000; font-weight: bold; }
        
        /* –ü–†–ï–í–¨–Æ –ö–ê–ú–ï–†–´ */
        #webcam-preview {
            position: absolute; bottom: 20px; left: 20px; width: 100px; height: 133px;
            background: #000; border: 1px solid var(--border); z-index: 10;
            border-radius: 10px; transform: scaleX(-1); object-fit: cover;
            opacity: 0; pointer-events: none; transition: opacity 0.3s;
        }
        #webcam-preview.visible { opacity: 0.7; pointer-events: auto; }

        /* RE–ñ–ò–ú FULLSCREEN (–ß–∏—Å—Ç—ã–π) */
        body.clean-mode .ui-panel, 
        body.clean-mode #webcam-preview { 
            opacity: 0 !important; 
            pointer-events: none !important; 
        }

        #fs-hint {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: rgba(255,255,255,0.5); font-size: 12px; pointer-events: none;
            opacity: 0; transition: opacity 1s; z-index: 50;
            text-shadow: 0 0 5px black; text-transform: uppercase;
        }
        body.clean-mode #fs-hint { animation: fadeHint 3s forwards; }
        @keyframes fadeHint { 0% {opacity:0;} 20% {opacity:1;} 80% {opacity:1;} 100% {opacity:0;} }
    </style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 24px;">AI MOBILE</h1>
        <div style="font-size: 12px; color: #aaa; margin-bottom: 10px;">–í–∫–ª—é—á–∏—Ç–µ —Ñ—Ä–æ–Ω—Ç–∞–ª—å–Ω—É—é –∫–∞–º–µ—Ä—É</div>
        <button id="start-btn" onclick="startSystem()">–°–¢–ê–†–¢</button>
    </div>

    <div id="canvas-container"></div>
    <video id="webcam-preview" class="visible" playsinline autoplay muted></video>
    
    <div id="fs-hint">–î–≤–æ–π–Ω–æ–π —Ç–∞–ø –¥–ª—è –º–µ–Ω—é</div>

    <div class="ui-panel" id="ui-panel">
        <button id="btn-full" class="toggle-btn" onclick="toggleFullscreen()">‚õ∂ –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</button>
        
        <div style="display: flex; gap: 8px; margin-bottom: 15px;">
            <button id="btn-mic" class="toggle-btn active" style="margin:0" onclick="toggleMic()">üé§</button>
            <button id="btn-cam" class="toggle-btn active status-lost" style="margin:0" onclick="toggleCam()">üì∑</button>
        </div>

        <div class="shape-grid">
            <button class="shape-btn active" onclick="setShape('sphere')">–°—Ñ–µ—Ä–∞</button>
            <button class="shape-btn" onclick="setShape('heart')">–°–µ—Ä–¥—Ü–µ</button>
            <!-- –í–ï–†–ù–£–õ –°–ê–¢–£–†–ù -->
            <button class="shape-btn" onclick="setShape('saturn')">–°–∞—Ç—É—Ä–Ω</button>
            <button class="shape-btn" onclick="setShape('dna')">–î–ù–ö</button>
        </div>
        
        <input type="color" id="colorPicker" value="#00ff88" style="width:100%; height:40px; border:none; background:none;">
    </div>

    <script>
        // --- MOBILE CONFIG ---
        const CONFIG = { particleCount: 12000, baseSize: 0.12, smooth: 0.1 };
        const STATE = {
            scale: 1, audioPulse: 0, rotX: 0, rotY: 0, tilt: 0,
            baseColor: new THREE.Color(0x00ff88)
        };
        const TARGET = { scale: 1, x: 0, y: 0, tilt: 0, detected: false };
        
        let scene, camera, renderer, particles;
        let audioCtx, analyser, dataArray;
        let isAudioAllowed = false;

        // --- FULLSCREEN LOGIC (FIXED) ---
        function toggleFullscreen() {
            // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å –Ω–∞ –∫–æ—Ä–Ω–µ–≤–æ–º —ç–ª–µ–º–µ–Ω—Ç–µ
            const elem = document.documentElement;
            
            if (!document.fullscreenElement) {
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) { /* Safari/Chrome */
                    elem.webkitRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                }
            }
        }

        // –°–ª—É—à–∞—Ç–µ–ª—å –∏–∑–º–µ–Ω–µ–Ω–∏–π, —á—Ç–æ–±—ã —Å–∫—Ä—ã–≤–∞—Ç—å UI
        document.addEventListener("fullscreenchange", onFullScreenChange, false);
        document.addEventListener("webkitfullscreenchange", onFullScreenChange, false);

        function onFullScreenChange() {
            const isFull = document.fullscreenElement || document.webkitFullscreenElement;
            if (isFull) {
                document.body.classList.add('clean-mode');
                document.getElementById('btn-full').innerText = "‚ùå –í—ã—Ö–æ–¥";
            } else {
                document.body.classList.remove('clean-mode');
                document.getElementById('btn-full').innerText = "‚õ∂ –ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω";
            }
        }

        // –î–≤–æ–π–Ω–æ–π —Ç–∞–ø –¥–ª—è –≤—ã—Ö–æ–¥–∞/–≤—Ö–æ–¥–∞ (—Ä–µ–∑–µ—Ä–≤–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
        let lastTap = 0;
        document.addEventListener('touchend', function(e) {
            // –ù–µ —Å—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å, –µ—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ –∫–Ω–æ–ø–∫—É
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTap;
            if (tapLength < 500 && tapLength > 0) {
                toggleFullscreen();
                e.preventDefault();
            }
            lastTap = currentTime;
        });

        // --- START ---
        async function startSystem() {
            const btn = document.getElementById('start-btn');
            btn.innerText = "–ó–ê–ì–†–£–ó–ö–ê...";
            
            initThree();

            try {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                analyser = audioCtx.createAnalyser();
                analyser.fftSize = 256;
                const source = audioCtx.createMediaStreamSource(stream);
                source.connect(analyser);
                dataArray = new Uint8Array(analyser.frequencyBinCount);
                isAudioAllowed = true;
            } catch(e) {
                console.warn("Audio fail");
                document.getElementById('btn-mic').classList.replace('active', 'off');
                document.getElementById('btn-mic').style.opacity = '0.3';
            }

            await initCameraAndMediaPipe();

            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('ui-panel').style.display = 'block';
        }

        // --- CAMERA ---
        async function initCameraAndMediaPipe() {
            const video = document.getElementById('webcam-preview');
            const camBtn = document.getElementById('btn-cam');

            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        facingMode: 'user', // –§—Ä–æ–Ω—Ç–∞–ª—å–Ω–∞—è –∫–∞–º–µ—Ä–∞
                        width: 